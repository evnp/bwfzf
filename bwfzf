#!/usr/bin/env bash

bwfzf() {
  local bwItems
  local keyPressed
  local lastAction
  local loginOrUnlock
  local nextField

  # attempt to fetch items list
  bwItems="$(bw list items)"
  if [[ "${bwItems}" == *"not logged in"* ]]; then
    loginOrUnlock="login"
  elif [[ "${bwItems}" == *"locked"* ]]; then
    loginOrUnlock="unlock"
  fi

  # if login or unlock required, update session env var then re-fetch
  if [[ -n "${loginOrUnlock}" ]]; then
    export BW_SESSION="$(bw "${loginOrUnlock}" --raw)"
    bwItems="$(bw list items)"
  fi

  # invoke fzf on items list
  bwItem="$(
    bw get item "$(
      echo "${bwItems}" \
      | jq -r '.[] | "\(.name) Â· \(.login.username) \(.id)" ' \
      | fzf-tmux --nth 1..-2 --with-nth 1..-2 \
      | awk '{print $NF}' \
    )"
  )"

  # perform an action (e.g. copy password to clipboard) then ask the user
  # whether to perform another action or exit
  while true; do

    # p key - print full entry
    if [[ "${keyPressed}" == "p" ]]; then
      lastAction=""
      echo "${bwItem//$(echo "${bwItem}" | jq -r '.login.password')/*****}" | jq .

    # enter key - copy password, username, uri, etc.
    elif [[ -z "${keyPressed}" ]]; then
      if [[ "${nextField}" == "username" ]]; then
        echo "${bwItem}" | jq -r '.login.username' | secure-pbcopy
        lastAction="Username copied!"
        nextField="uri"
      elif [[ "${nextField}" == "uri" ]]; then
        echo "${bwItem}" | jq -r '.login.uri' | secure-pbcopy
        lastAction="URI copied!"
        nextField="password"
      else
        echo "${bwItem}" | jq -r '.login.password' | secure-pbcopy
        lastAction="Password copied!"
        nextField="username"
      fi

    # any other key - exit
    else
      break
    fi

    read -rsn1 -p "
${lastAction}
  enter -> copy ${nextField}
  p key -> print full entry (password redacted)
  other -> exit
" keyPressed
  done
}
